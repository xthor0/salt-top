{% if grains.get('os_family', '') == 'RedHat' %}
{% set nrpe_user = "nrpe" %}
{% set lib_location = "/usr/lib64" %}
{% endif %}

{% if grains.get('os_family', '') == 'Rocky' %}
{% set nrpe_user = "nrpe" %}
{% set lib_location = "/usr/lib64" %}
{% endif %}

{% if grains.get('os_family', '') == 'Debian' %}
{% set nrpe_user = "nagios" %}
{% set lib_location = "/usr/lib" %}
{% endif %}

log_facility=daemon
debug=0
pid_file=/var/run/{{ nrpe_user }}/nrpe.pid
server_port=5666
nrpe_user={{ nrpe_user }}
nrpe_group={{ nrpe_user }}
allowed_hosts=127.0.0.1,::1,{{ salt['pillar.get']('icinga2:server_ip') }}
dont_blame_nrpe=0
allow_bash_command_substitution=0
command_timeout=60
connection_timeout=300

command[check_users]={{ lib_location }}/nagios/plugins/check_users -w 3 -c 5
command[check_load]={{ lib_location }}/nagios/plugins/check_load -r -w 1,1,1 -c 2,2,2
command[check_disk]={{ lib_location }}/nagios/plugins/check_disk -w 20% -c 10% -p / -p /boot -p /home -p /var -p /tmp
command[check_zombie_procs]={{ lib_location }}/nagios/plugins/check_procs -w 5 -c 10 -s Z
command[check_total_procs]={{ lib_location }}/nagios/plugins/check_procs -w 260 -c 300

{# this'll change depending on whether or not the system actually has swap #}
{% set swap_devs = salt['cmd.shell']('swapon --show | wc -l')|int %}
{% if swap_devs >= 2 %}
command[check_swap]={{ lib_location }}/nagios/plugins/check_swap -w 50 -c 25
{% else %}
command[check_swap]=echo No swap to check; exit 0
{% endif %}

